<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b0f14" />
    <title>Chainring Wraiths</title>
    <meta
      name="description"
      content="Chainring Wraiths â€” a cycling coven of shadowy speed"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700..900&family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b0f14;
        --bg-elev: #11161c;
        --text: #e6edf3;
        --muted: #9aa4ae;
        --accent: #7c3aed;
        --accent-2: #9333ea;
        --ring: rgba(124, 58, 237, 0.35);
        --border: rgba(124, 58, 237, 0.25);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(
            1200px 600px at 10% -10%,
            rgba(124, 58, 237, 0.12),
            transparent 40%
          ),
          var(--bg);
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
        text-decoration: none;
      }
      a:hover {
        color: var(--accent);
      }

      .container {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 24px;
      }

      .nav {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: saturate(140%) blur(8px);
        background: rgba(17, 22, 28, 0.6);
        border-bottom: 1px solid var(--border);
      }
      .nav-inner {
        height: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Cinzel, Georgia, serif;
      }
      .brand {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        font-weight: 800;
        letter-spacing: 0.4px;
      }
      .brand svg {
        display: block;
      }
      .brand img {
        display: block;
        height: 28px;
        width: 28px;
        border-radius: 4px;
        object-fit: cover;
      }
      @media (min-width: 720px) {
        .brand img {
          height: 96px;
          width: 96px;
        }
        .nav-inner {
          height: 128px;
          font-size: 36px;
        }
      }
      .brand span {
        font-variant-ligatures: none;
      }
      .nav-links {
        display: flex;
        align-items: center;
        gap: 18px;
        font-weight: 600;
      }
      .nav-links a {
        opacity: 0.9;
      }
      .nav-links a:hover {
        opacity: 1;
      }
      .cta {
        display: inline-block;
        padding: 8px 14px;
        border-radius: 999px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b0f14;
        box-shadow: 0 0 0 2px var(--ring) inset,
          0 8px 24px rgba(124, 58, 237, 0.35);
      }

      .hero {
        position: relative;
        display: grid;
        align-items: center;
        min-height: 64vh;
        border-bottom: 1px solid var(--border);
      }
      .hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background: url("assets/cover.JPG") center/cover no-repeat;
        filter: brightness(0.45) saturate(0.9) contrast(1.05);
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
            1200px 420px at 10% 15%,
            rgba(124, 58, 237, 0.28),
            transparent 60%
          ),
          linear-gradient(to bottom, rgba(11, 15, 20, 0.05), var(--bg) 75%);
      }
      .hero-content {
        position: relative;
        z-index: 1;
        padding: clamp(48px, 12vw, 96px) 0;
      }
      .eyebrow {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--muted);
        background: rgba(17, 22, 28, 0.6);
      }
      h1 {
        font-family: Cinzel, Georgia, serif;
        font-size: clamp(36px, 6vw, 64px);
        line-height: 1.05;
        margin: 14px 0 12px;
        letter-spacing: 0.5px;
      }
      .tagline {
        color: var(--muted);
        font-size: 18px;
        max-width: 60ch;
      }
      .cta-row {
        margin-top: 22px;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
      }
      .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 10px;
        font-weight: 700;
        border: 1px solid var(--border);
      }
      .btn.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b0f14;
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.45);
      }
      .btn.ghost {
        background: rgba(17, 22, 28, 0.6);
        color: var(--text);
      }

      main.container {
        padding: 48px 24px 80px;
      }
      section.section {
        padding: 36px 0;
      }
      h2 {
        font-family: Cinzel, Georgia, serif;
        font-size: clamp(24px, 3.6vw, 36px);
        margin: 0 0 12px;
      }
      p.lead {
        color: var(--muted);
        margin: 0 0 6px;
      }

      .grid {
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 720px) {
        .grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(17, 22, 28, 0.85),
          rgba(17, 22, 28, 0.85)
        );
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 0 0 2px var(--ring) inset;
        transition: box-shadow 120ms ease, transform 120ms ease;
        cursor: pointer;
      }
      .card:hover {
        box-shadow: 0 0 0 2px var(--accent) inset,
          0 12px 32px rgba(124, 58, 237, 0.35);
        transform: translateY(-1px);
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 18px;
      }
      .card p {
        margin: 0;
        color: var(--muted);
      }

      .list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 12px;
      }
      .list li {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .badge {
        font-size: 12px;
        color: var(--muted);
        padding: 4px 8px;
        border: 1px solid var(--border);
        border-radius: 999px;
      }

      footer {
        border-top: 1px solid var(--border);
        color: var(--muted);
      }
      footer .inner {
        height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      /* Rides + status */
      .rides-grid {
        margin-top: 20px;
      }
      .ride-meta {
        color: var(--muted);
        margin-top: 6px;
      }
      .attendees {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      /* Enhanced ride cards */
      .ride-card {
        position: relative;
        overflow: hidden;
        padding: 0;
      }
      .ride-card::after {
        content: "";
        position: absolute;
        inset: 0 0 0 auto;
        width: 4px;
        background: linear-gradient(180deg, var(--accent), var(--accent-2));
        opacity: 0.7;
      }
      .ride-head {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 12px;
      }
      .ride-title {
        margin: 0;
        font-size: 20px;
        letter-spacing: 0.2px;
      }
      .date-pill {
        display: inline-flex;
        align-items: baseline;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b0f14;
        box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
        font-weight: 800;
      }
      .date-day {
        font-size: 20px;
        line-height: 1;
      }
      .date-mon {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
      }
      .date-wrap {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
      }
      .days-til {
        font-size: 11px;
        line-height: 1;
        color: var(--muted);
        margin-top: 4px;
      }
      .open-icon {
        opacity: 0.85;
        font-size: 14px;
      }
      .location-chip {
        position: absolute;
        right: 14px;
        bottom: 14px;
        background: rgba(17, 22, 28, 0.6);
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
        pointer-events: none;
        backdrop-filter: blur(2px);
      }
      .corner-chips {
        position: absolute;
        right: 14px;
        bottom: 14px;
        display: flex;
        gap: 8px;
        pointer-events: none;
      }
      .chip {
        background: rgba(17, 22, 28, 0.6);
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
        backdrop-filter: blur(2px);
      }
      .chip-days {
        color: #c4b5fd;
        border-color: rgba(124, 58, 237, 0.35);
        background: rgba(124, 58, 237, 0.12);
        display: none;
      }
      .ride-card .card-link {
        display: block;
        width: 100%;
        height: 100%;
        padding: 18px 18px 64px;
      }
      /* Mobile tweaks */
      @media (max-width: 720px) {
        .container {
          padding: 0 16px;
        }
        .nav-inner {
          height: 56px;
        }
        .nav-links {
          gap: 12px;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }
        .nav-links::-webkit-scrollbar {
          display: none;
        }
        .tagline {
          font-size: 16px;
        }
        .ride-title {
          font-size: 18px;
        }
        .date-day {
          font-size: 18px;
        }
        .date-mon {
          font-size: 11px;
        }
        .sponsor-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .sponsor img {
          height: 56px;
        }
      }
      @media (max-width: 380px) {
        .core-grid {
          grid-template-columns: 1fr;
        }
        .sponsor-grid {
          grid-template-columns: 1fr;
        }
      }
      .status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }
      .status-r {
        background: rgba(34, 197, 94, 0.15);
        color: #86efac;
        border-color: rgba(34, 197, 94, 0.35);
      }
      .status-x {
        background: rgba(234, 179, 8, 0.15);
        color: #fde68a;
        border-color: rgba(234, 179, 8, 0.35);
      }
      .status-q {
        background: rgba(59, 130, 246, 0.15);
        color: #93c5fd;
        border-color: rgba(59, 130, 246, 0.35);
      }
      .status-n {
        background: rgba(239, 68, 68, 0.15);
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.35);
      }
      .legend {
        margin-top: 14px;
        display: flex;
        gap: 12px;
        align-items: center;
        color: var(--muted);
        flex-wrap: wrap;
      }
      .legend .status {
        border: none;
      }
      .card-link {
        display: block;
        color: inherit;
        text-decoration: none;
      }
      .card-link:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        border-radius: 14px;
      }
      /* Core riders */
      .core-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin-bottom: 16px;
      }
      @media (min-width: 720px) {
        .core-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      .core-card {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: box-shadow 120ms ease, border-color 120ms ease,
          transform 120ms ease;
      }
      .core-name {
        font-weight: 700;
      }
      .core-card:hover {
        border-color: var(--accent);
        box-shadow: 0 8px 28px rgba(124, 58, 237, 0.25);
        transform: translateY(-1px);
      }
      .core-card.active {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--ring) inset,
          0 10px 30px rgba(124, 58, 237, 0.35);
      }
      .filter-indicator {
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
      }
      .filter-indicator .clear-btn {
        border: 1px solid var(--border);
        background: rgba(17, 22, 28, 0.6);
        color: var(--text);
        padding: 4px 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .status-selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent) inset;
      }
      /* Sponsors */
      .sponsors {
        padding: 24px 0;
      }
      .sponsor-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
        align-items: center;
      }
      @media (min-width: 720px) {
        .sponsor-grid {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }
      .sponsor {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: box-shadow 120ms ease, transform 120ms ease,
          border-color 120ms ease;
      }
      .sponsor:hover {
        box-shadow: 0 0 0 2px var(--accent) inset,
          0 12px 28px rgba(124, 58, 237, 0.35);
        border-color: var(--accent);
        transform: translateY(-1px);
      }
      .sponsor a {
        display: flex;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
        border-radius: inherit;
      }
      .sponsor a:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        border-radius: 10px;
      }
      .sponsor img {
        max-width: 100%;
        height: 64px;
        object-fit: contain;
        filter: grayscale(25%);
      }
    </style>
  </head>
  <body>
    <header class="nav" role="banner">
      <div class="container nav-inner">
        <a class="brand" href="#" aria-label="Chainring Wraiths Home">
          <img src="assets/chainstyle-white.png" alt="Chainring Wraiths logo" />
          <span>Chainring Wraiths</span>
        </a>
        <nav class="nav-links" aria-label="Primary">
          <a href="#rides">Rides</a>
        </nav>
      </div>
    </header>

    <section class="hero" role="region" aria-label="Hero">
      <div class="container hero-content">
        <span class="eyebrow">One ride to rule them all</span>
        <h1>Chainring Wraiths</h1>
        <p class="tagline">Where aero meets Mordor</p>
        <div class="cta-row">
          <a class="btn primary" href="#rides">View Upcoming Rides</a>
          <a class="btn ghost" href="#lore">Read the Lore</a>
        </div>
      </div>
    </section>

    <main class="container">
      <section id="lore" class="section">
        <h2>Legend of the Wraiths</h2>
        <p class="lead">
          Forged in the shadows of steep climbs and questionable life choices,
          the Chainring Wraiths ride when others rest. Not all who wander are
          lost â€” some are simply off-route without cell service.
        </p>
        <p class="lead">
          We relish tailwinds, respect headwinds, and fear only bonks. Coffee is
          our elixir, snacks our mithril, and the drop bar our weapon of choice.
        </p>
      </section>

      <section id="roster" class="section">
        <h2>The Four Riders</h2>
        <h3 style="margin: 0 0 10px">Core Riders</h3>
        <div class="core-grid" aria-label="Core Riders">
          <div class="core-card" data-rider="Sam" role="button" tabindex="0">
            <span class="core-name">Sam</span><span class="badge">Leader</span>
          </div>
          <div class="core-card" data-rider="San" role="button" tabindex="0">
            <span class="core-name">San</span>
          </div>
          <div class="core-card" data-rider="Blake" role="button" tabindex="0">
            <span class="core-name">Blake</span>
          </div>
          <div class="core-card" data-rider="Rich" role="button" tabindex="0">
            <span class="core-name">Rich</span>
          </div>
        </div>
      </section>

      <section id="rides" class="section">
        <h2>Upcoming Rides</h2>
        <div class="legend" aria-label="Legend">
          <span class="status status-r">r = Registered</span>
          <span class="status status-x">x = Probably</span>
          <span class="status status-q">? = Hopefully</span>
          <span class="status status-n">n = Not attending</span>
        </div>
        <div id="rides-grid" class="grid rides-grid" aria-live="polite"></div>
      </section>

      <section id="sponsors" class="section sponsors">
        <h2>Sponsors</h2>
        <div class="sponsor-grid">
          <div class="sponsor">
            <a
              href="https://www.mtndev.com/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <img src="assets/mtndev.png" alt="mtndev sponsor" />
            </a>
          </div>
          <div class="sponsor">
            <a
              href="https://www.tubal-reversal.net/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <img
                src="assets/personal-choice.webp"
                alt="Personal Choice sponsor"
              />
            </a>
          </div>
          <div class="sponsor">
            <a
              href="https://refittherapy.com/"
              target="_blank"
              rel="noopener noreferrer"
            >
              <img src="assets/refit-therapy.svg" alt="Refit Therapy sponsor" />
            </a>
          </div>
        </div>
      </section>

      <section id="join" class="section">
        <h2>Join the Fellowship</h2>
        <p class="lead">
          New riders and wandering souls welcome. Helmets required. Sense of
          humor mandatory.
        </p>
        <div class="cta-row">
          <a
            href="mailto:chainringwraiths@gmail.com"
            target="_blank"
            class="btn primary"
            href="#"
            >Pledge Your Allegiance</a
          >
          <a
            href="mailto:chainringwraiths@gmail.com"
            target="_blank"
            class="btn ghost"
            href="#"
            >Whisper to the Wraiths</a
          >
        </div>
      </section>
    </main>

    <footer>
      <div class="container inner">
        <span>Â© <span id="year"></span> Chainring Wraiths</span>
        <span>Ride safe. Fear no climb.</span>
      </div>
    </footer>

    <script>
      const csvPath = "Chainring Wraiths - 2025.csv";
      const statusMap = {
        r: "status-r",
        x: "status-x",
        "?": "status-q",
        n: "status-n",
      };
      const memberKeys = [
        "Sam",
        "Blake",
        "San",
        "Rich",
        "Austin",
        "Bill",
        "Other",
      ];

      // Fallback CSV embedded to support file:// viewing without a server
      const fallbackCsv = `Date,Description,Distance,Location,Website,Sam,Blake,San,Rich,Austin,Bill,Other
      9/10/2025,OCCX - Weeknight Training Series,20 - 40 Minutes,"Raleigh, NC",https://www.bikereg.com/cxcentral-occx25,r,,,,,,
      9/17/2025,OCCX - Weeknight Training Series,20 - 40 Minutes,"Raleigh, NC",https://www.bikereg.com/cxcentral-occx25,r,,,,,,
      9/20/2025,Kershaw Gold Rush,83,"Kershaw, SC",https://www.southeastgravel.com/2025-kershaw-gold-rush,r,r,n,r,r,,
      9/24/2025,OCCX - Weeknight Training Series,20 - 40 Minutes,"Raleigh, NC",https://www.bikereg.com/cxcentral-occx25,n,,,,,,
      9/27/2025,CX Central - Camp Kanata,30 minutes,"Wake Forest, NC",https://www.bikereg.com/cxcentral-kanatacx,x,,,,,,
      10/4/2025,CX Central - Sandhills,30 minutes,"Pinehurst, NC",https://www.bikereg.com/cxcentral-sandhillscx,x,,,,,,
      10/5/2025,CX Central - Rock Quarry,30 minutes,"Durham, NC",Not Posted Yet,x,,,,,,
      10/11/2025,2025 NCCX Race #1 Gibsonville,45 minutes,"Gibsonville, NC",https://www.bikereg.com/nccxrace1gibsonville,x,x,?,,,,
      10/12/2025,2025 NCCX Race #2 Raleigh,45 minutes,"Raleigh, NC",https://www.bikereg.com/nccxrace2raleigh,x,x,?,,,,
      10/19/2025,2025 NCCX Race #3 Boone,45 minutes,"Boone, NC",https://www.bikereg.com/nccxrace3boone,x,?,n,,,,
      10/25/2025,2025 NCCX Race #4 Winston Salem,45 minutes,"Winston Salem, NC",https://www.bikereg.com/nccxrace4winstonsalem,?,,,,,,
      10/26/2025,2025 NCCX Race #5 Winston Salem,45 minutes,"Winston Salem, NC",https://www.bikereg.com/nccxrace5winstonsalem,n,x,,,,,
      11/22/2025,2025 North Carolina Grand Prix,30 minutes,"Hendersonville, NC",https://www.bikereg.com/nccxncgp2025,?,,,,,,`;

      function parseCsv(text) {
        const lines = text.split(/\r?\n/).filter(Boolean);
        const header = lines.shift();
        const rows = [];
        for (const line of lines) {
          const cells = [];
          let cur = "";
          let inQuotes = false;
          for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') {
              if (inQuotes && line[i + 1] === '"') {
                cur += '"';
                i++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if (ch === "," && !inQuotes) {
              cells.push(cur.trim());
              cur = "";
            } else {
              cur += ch;
            }
          }
          cells.push(cur.trim());
          if (cells.length > 1) rows.push(cells);
        }
        return rows;
      }

      function toUrl(val) {
        if (!val) return null;
        const v = String(val).trim();
        if (/^https?:\/\//i.test(v)) return v;
        if (/^www\./i.test(v)) return `https://${v}`;
        return null;
      }

      function createRideCard(row) {
        const [date, description, distance, location, website, ...statuses] =
          row;
        const article = document.createElement("article");
        article.className = "card ride-card";
        const title = document.createElement("h3");
        title.className = "ride-title";
        title.textContent = `${description}`;
        const meta = document.createElement("p");
        meta.className = "ride-meta";
        meta.textContent = `${distance}`;
        // Build per-card URL: direct if looks like URL, otherwise Google search
        let url = toUrl(website);
        if (!url) {
          const q = `${description} ${location} ${date}`;
          url = `https://www.google.com/search?q=${encodeURIComponent(q)}`;
        }

        const attendees = document.createElement("div");
        attendees.className = "attendees";
        memberKeys.forEach((name, idx) => {
          const s = statuses[idx]?.toLowerCase();
          if (!s) return;
          const badge = document.createElement("span");
          const cls = statusMap[s];
          badge.className = `status ${cls ?? ""}`.trim();
          badge.textContent = name;
          badge.setAttribute("aria-label", `${name}: ${s}`);
          attendees.appendChild(badge);
        });

        // Wrap card contents in an anchor so the whole card is clickable
        const anchor = document.createElement("a");
        anchor.href = url;
        anchor.target = "_blank";
        anchor.rel = "noopener";
        anchor.className = "card-link";
        // Build a colorful date pill
        const d = new Date(date);
        const month = d.toLocaleString(undefined, { month: "short" });
        const day = String(d.getDate());
        const dateWrap = document.createElement("span");
        dateWrap.className = "date-wrap";
        const datePill = document.createElement("span");
        datePill.className = "date-pill";
        const dayEl = document.createElement("span");
        dayEl.className = "date-day";
        dayEl.textContent = day;
        const monEl = document.createElement("span");
        monEl.className = "date-mon";
        monEl.textContent = month;
        datePill.appendChild(dayEl);
        datePill.appendChild(monEl);
        const daysTil = document.createElement("span");
        daysTil.className = "chip chip-days";
        const now = new Date();
        const diffMs =
          new Date(d.toDateString()) - new Date(now.toDateString());
        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
        daysTil.textContent = `${
          diffDays >= 0 ? diffDays : Math.abs(diffDays)
        } ${diffDays === 1 ? "day" : "days"}`;
        dateWrap.appendChild(datePill);
        // move days chip to corner with location

        const head = document.createElement("div");
        head.className = "ride-head";
        head.appendChild(dateWrap);
        head.appendChild(title);
        // External icon
        const icon = document.createElement("span");
        icon.className = "open-icon";
        icon.innerHTML = "&#8599;";
        head.appendChild(icon);

        anchor.appendChild(head);
        anchor.appendChild(meta);
        if (attendees.children.length) anchor.appendChild(attendees);
        const chips = document.createElement("div");
        chips.className = "corner-chips";
        const loc = document.createElement("span");
        loc.className = "chip";
        loc.textContent = location;
        chips.appendChild(loc);
        chips.appendChild(daysTil);
        article.appendChild(chips);
        article.appendChild(anchor);
        return article;
      }

      async function tryFetchCsv(paths) {
        for (const path of paths) {
          try {
            console.info("loadRides:fetch:attempt", {
              path,
              protocol: location.protocol,
            });
            const res = await fetch(path, { cache: "no-store" });
            console.info("loadRides:fetch:response", {
              ok: res.ok,
              status: res.status,
              statusText: res.statusText,
            });
            if (!res.ok) continue;
            const text = await res.text();
            if (text && text.trim().length > 0) return text;
          } catch (e) {
            console.warn("loadRides:fetch:error", {
              path,
              message: e?.message,
            });
          }
        }
        return null;
      }

      let activeRider = null; // e.g., 'Sam'

      function riderStatusIncluded(statuses, riderName) {
        const idx = memberKeys.indexOf(riderName);
        if (idx === -1) return false;
        const s = statuses[idx]?.toLowerCase();
        return Boolean(s);
      }

      async function loadRides() {
        const grid = document.getElementById("rides-grid");
        grid.innerHTML = "";
        console.info("loadRides:start", {
          href: location.href,
          protocol: location.protocol,
        });
        // Always use embedded CSV for now
        const textToParse = fallbackCsv;
        try {
          const rows = parseCsv(textToParse);
          const all = rows.filter((r) =>
            /\d{1,2}\/\d{1,2}\/\d{4}/.test(r[0] ?? "")
          );
          const filtered = activeRider
            ? all.filter((row) =>
                riderStatusIncluded(row.slice(5), activeRider)
              )
            : all;
          console.info("loadRides:parsed", {
            totalRows: rows.length,
            filtered: filtered.length,
            sample: filtered.slice(0, 2),
            activeRider,
          });
          filtered.forEach((row) => grid.appendChild(createRideCard(row)));
          if (!grid.children.length) {
            grid.innerHTML = '<p class="lead">No rides available.</p>';
          }
        } catch (err) {
          grid.innerHTML =
            '<p class="lead">Could not load rides at this time.</p>';
          console.error("loadRides:parse:error", err);
        }
      }

      document.getElementById("year").textContent = String(
        new Date().getFullYear()
      );

      // Rider filter interactions
      function ensureFilterIndicator() {
        let indicator = document.getElementById("rider-filter");
        if (!indicator) {
          const ridesSection = document.getElementById("rides");
          const legend = ridesSection?.querySelector(".legend");
          indicator = document.createElement("div");
          indicator.id = "rider-filter";
          indicator.className = "filter-indicator";
          const label = document.createElement("span");
          label.innerHTML = 'Filtering by <strong id="filter-name"></strong>';
          const btn = document.createElement("button");
          btn.id = "clear-filter";
          btn.type = "button";
          btn.className = "clear-btn";
          btn.textContent = "Clear";
          indicator.appendChild(label);
          indicator.appendChild(btn);
          legend?.insertAdjacentElement("afterend", indicator);
        }
        return indicator;
      }

      function setActiveRider(name) {
        activeRider = name;
        const indicator = ensureFilterIndicator();
        const nameEl = indicator.querySelector("#filter-name");
        if (activeRider && nameEl) nameEl.textContent = activeRider;
        if (activeRider) indicator.style.display = "inline-flex";
        else indicator.style.display = "none";
        document.querySelectorAll(".core-card").forEach((el) => {
          if (el.getAttribute("data-rider") === activeRider)
            el.classList.add("active");
          else el.classList.remove("active");
        });
        loadRides();
      }

      document.querySelectorAll(".core-card[data-rider]").forEach((card) => {
        card.addEventListener("click", () => {
          const name = card.getAttribute("data-rider");
          setActiveRider(activeRider === name ? null : name);
        });
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            const name = card.getAttribute("data-rider");
            setActiveRider(activeRider === name ? null : name);
          }
        });
      });

      document.addEventListener("click", (e) => {
        const tgt = e.target;
        if (tgt && tgt.id === "clear-filter") setActiveRider(null);
      });

      loadRides();
    </script>
  </body>
</html>
